 devops-netology

# Домашнее задание к занятию "4.1. Командная оболочка Bash: Практические навыки"

## Обязательные задания

### 1. Есть скрипт:
```bash
a=1
b=2
c=a+b
d=$a+$b
e=$(($a+$b))
```
	* Какие значения переменным c,d,e будут присвоены?
	* Почему?
   c=a+b -переменной с будет присвоено текстовое значение "a+b". Так как в bash все переменные текстовые и в данном выражении перед a и b нет символа $Б значит a и b не являются переменным, а являются обычным текстом.

   d=$a+$b - переменной d будет присвоено текстовое значение "1+2". $a и $b в данном случае в выражении используются как переменные, но так как переменные это текстовые, то и резльтатом будет текстовая переменная, а не результат арифметического выражения.

   e=$(($a+$b)) - переменной e будет присвоено значение 3. Конструкция ((...)) в bash используется для выполнения арифметических операций, а символ $ перед перменными a и b, дает понять, что в арифметическом выражении будут использоватся значения этих переменных.
  
### 2. На нашем локальном сервере упал сервис и мы написали скрипт, который постоянно проверяет его доступность, записывая дату проверок до тех пор, пока сервис не станет доступным. В скрипте допущена ошибка, из-за которой выполнение не может завершиться, при этом место на Жёстком Диске постоянно уменьшается. Что необходимо сделать, чтобы его исправить:
	```bash
	while ((1==1)
	do
	curl https://localhost:4757
	if (($? != 0))
	then
	date >> curl.log
	fi
	done
	```
   В данном случае скрипт будет работать даже когда сервис станет доступным, потому что отсутствует условие выхода их цикла при успешном результате curl.
   Так как при успешном результате curl дает 0, нужно добавить условие else  вкотором прервать цикл.
   В результате скрипт будет выглядеть следующим образом:
```
  bash
   while ((1==1))
   do
   curl https://localhost:4757
   if (($? != 0))
   then
   date >> curl.log
   else
   break
   fi
   done
```

### 3. Необходимо написать скрипт, который проверяет доступность трёх IP: 192.168.0.1, 173.194.222.113, 87.250.250.242 по 80 порту и записывает результат в файл log. Проверять доступность необходимо пять раз для каждого узла.
   Скрипт постарался сделать более универсальным, чтобы проще было добавить количество проверяемых серверов, просто добавив их в массив и добавил при записи в лог время опроса сервера. 

```
#!/usr/bin/env bash
cat /dev/null > availability.log # создаем чистый файл
servers_array=("http://192.168.0.1:80" "http://173.194.222.113:80" "http://87.250.250.242:80") # саздаем массив для проверки серверов
for (( i=0; i<${#servers_array[@]}; i++ )) # создаем цикл по размеру массива
do
n=5 # количество проверок
while (($n>0)) # создаем цикл для проверки доступности серверов из массива
do
curl -i ${servers_array[$i]} # проверка доступности
case $? in # case для записи успешная проверка или нет по результату последней команды, включая данные о времени проверки
   [0] ) echo "`date` - cервер по адресу ${servers_array[$i]} доступен" >> availability.log
   ;;
   * ) echo "`date` - cервер по адресу ${servers_array[$i]} не доступен" >> availability.log
   ;;
esac
let " n -= 1 " # уменьшаем счетчик попыток
sleep 5 # пауза 5 сек
done
done
```
   Содержимое файла availability.log
```
vagrant@vagrant:~/devops-netology$ cat availability.log 
Mon 02 Aug 2021 03:04:50 PM MSK - cервер по адресу http://192.168.0.1:80 не доступен
Mon 02 Aug 2021 03:04:57 PM MSK - cервер по адресу http://192.168.0.1:80 не доступен
Mon 02 Aug 2021 03:05:04 PM MSK - cервер по адресу http://192.168.0.1:80 не доступен
Mon 02 Aug 2021 03:05:11 PM MSK - cервер по адресу http://192.168.0.1:80 не доступен
Mon 02 Aug 2021 03:05:18 PM MSK - cервер по адресу http://192.168.0.1:80 не доступен
Mon 02 Aug 2021 03:05:23 PM MSK - cервер по адресу http://173.194.222.113:80 доступен
Mon 02 Aug 2021 03:05:28 PM MSK - cервер по адресу http://173.194.222.113:80 доступен
Mon 02 Aug 2021 03:05:33 PM MSK - cервер по адресу http://173.194.222.113:80 доступен
Mon 02 Aug 2021 03:05:38 PM MSK - cервер по адресу http://173.194.222.113:80 доступен
Mon 02 Aug 2021 03:05:43 PM MSK - cервер по адресу http://173.194.222.113:80 доступен
Mon 02 Aug 2021 03:05:48 PM MSK - cервер по адресу http://87.250.250.242:80 доступен
Mon 02 Aug 2021 03:05:53 PM MSK - cервер по адресу http://87.250.250.242:80 доступен
Mon 02 Aug 2021 03:05:59 PM MSK - cервер по адресу http://87.250.250.242:80 доступен
Mon 02 Aug 2021 03:06:04 PM MSK - cервер по адресу http://87.250.250.242:80 доступен
Mon 02 Aug 2021 03:06:09 PM MSK - cервер по адресу http://87.250.250.242:80 доступен
```

### 4. Необходимо дописать скрипт из предыдущего задания так, чтобы он выполнялся до тех пор, пока один из узлов не окажется недоступным. Если любой из узлов недоступен - IP этого узла пишется в файл error, скрипт прерывается
   
   Изменил скрипт, добавил запись по ошибке и остановку скрипта через break 2.
```
#!/usr/bin/env bash
cat /dev/null > availability.log # создаем чистый файл логов для успешной проверки
cat /dev/null > error.log # создаем чистый файл для проверок с ошибкой 
servers_array=("http://192.168.0.1:80" "http://173.194.222.113:80" "http://87.250.250.242:80") # саздаем массив для проверки серверов
for (( i=0; i<${#servers_array[@]}; i++ )) # создаем цикл по размеру массива
do
n=5 # количество проверок
while (($n>0)) # создаем цикл для проверки доступности серверов из массива
do
curl -i ${servers_array[$i]} # проверка доступности
case $? in # case для записи успешная проверка или нет по результату последней команды, включая данные о времени проверки
   [0] ) echo "`date` - cервер по адресу ${servers_array[$i]} доступен" >> availability.log
   ;;
   * ) 
    echo "`date` - cервер по адресу ${servers_array[$i]} не доступен" >> error.log
    break 2 # прерываем скрипт по ошибке, так как скрипт вложенный используем break 2 
   ;;
esac
let " n -= 1 " # уменьшаем счетчик попыток
sleep 5 # пауза 5 сек
done
done
```
   Результат выполнения скрипта и содержание файла error.log
```
vagrant@vagrant:~/devops-netology$ ./test.sh 
curl: (7) Failed to connect to 192.168.0.1 port 80: Connection refused
vagrant@vagrant:~/devops-netology$ cat error.log 
Mon 02 Aug 2021 03:33:51 PM MSK - cервер по адресу http://192.168.0.1:80 не доступен
vagrant@vagrant:~/devops-netology$
``` 
## Дополнительное задание (со звездочкой*) - необязательно к выполнению

Мы хотим, чтобы у нас были красивые сообщения для коммитов в репозиторий. Для этого нужно написать локальный хук для git, который будет проверять, что сообщение в коммите содержит код текущего задания в квадратных скобках и количество символов в сообщении не превышает 30. Пример сообщения: \[04-script-01-bash\] сломал хук.
   Хук проверил, работает. Так как делаю в своем репозитории домашки, то код задания вписал руками, чтобы можно было проверить работает или нет, по идее код задания нужно было брать из пути в репозито>
```
vagrant@vagrant:~/devops-netology$ cat .git/hooks/commit-msg
#!/usr/bin/env bash

while read line; do
    # Пропускаем комментарий        
    if [ "${line:0:1}" == "#" ]; then
        continue
    fi
    if [[ $line != *"[04-script-01-bash]"* ]]; then
        echo "В сообщении коммита нет кода текущего задания."
        exit 1
    elif [ ${#line} -gt 30 ]; then
        echo "Сообщение коммита должно быть не более 30 символов."
        echo "Ваше сообщение содержит ${#line} символов."
        echo "Сообщение: ${line}"
        exit 1
    fi
done < "${1}"

exit 0
vagrant@vagrant:~/devops-netology$
```
   Результат проверки хука:
```
vagrant@vagrant:~/devops-netology$ git commit -am '[04-script-01-bashswsfegfwsghwrhewrherujhwue5ujwer5ujwr465ui46j6'
В сообщении коммита нет кода текущего задания.
vagrant@vagrant:~/devops-netology$ git commit -am '[04-script-01-bash]swsfegfwsghwrhewrherujhwue5ujwer5ujwr465ui46j6'
Сообщение коммита должно быть не более 30 символов.
Ваше сообщение содержит 65 символов.
Сообщение: [04-script-01-bash]swsfegfwsghwrhewrherujhwue5ujwer5ujwr465ui46j6      
vagrant@vagrant:~/devops-netology$ git commit -am '[04-script-01-bash] сломал хук'
[main ef9eae9] [04-script-01-bash] сломал хук
 1 file changed, 163 insertions(+), 399 deletions(-)
 rewrite README.md (99%)
vagrant@vagrant:~/devops-netology$ git reset HEAD~
Unstaged changes after reset:
M       README.md
vagrant@vagrant:~/devops-netology$                 
```
